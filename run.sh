#!/bin/bash

trap 'exit 3' SIGINT

MAP_bt16="0,1,5,4,13,9,2,14,3,6,10,15,8,12,11,7"
MAP_bt25="0,4,1,16,9,8,12,13,5,17,20,2,21,3,24,6,10,7,11,23,14,22,15,19,18"
MAP_bt64="0,8,1,21,17,13,32,2,3,6,31,35,9,15,47,23,4,49,11,33,14,36,7,18,40,41,26,19,27,29,28,5,10,37,43,60,16,30,12,51,44,53,34,22,59,24,25,48,55,38,57,39,62,46,50,61,63,20,58,52,45,54,42,56"

MAP_cg16="0,1,13,9,4,8,12,2,14,6,10,5,3,11,15,7"
MAP_cg32="0,4,12,8,20,16,24,28,1,9,5,13,25,29,17,21,2,10,6,14,22,18,30,26,3,7,15,11,31,27,19,23"
MAP_cg64="0,1,21,13,33,9,2,3,10,14,30,42,26,18,29,20,46,6,15,23,24,55,35,38,56,25,27,31,63,50,61,4,57,7,8,28,5,32,59,36,39,37,12,16,44,62,34,19,22,41,11,45,53,47,51,60,43,52,17,48,54,40,58,49"

MAP_dt16="0,4,8,12,1,5,9,13,2,6,10,14,3,7,11,15"
MAP_dt32="0,4,12,8,16,20,24,28,1,5,9,13,17,21,25,29,2,6,10,14,22,26,30,3,7,11,15,19,23,18,27,31"
MAP_dt64="0,4,32,36,8,40,12,44,16,48,20,24,52,56,28,60,1,33,5,37,9,41,13,45,17,49,21,53,25,57,29,61,2,34,6,14,46,10,38,42,22,54,26,58,30,62,3,35,7,39,11,43,15,47,19,51,23,55,27,59,31,63,18,50"

MAP_ep16="0,1,4,2,14,3,7,5,12,8,6,10,9,11,15,13"
MAP_ep32="0,4,8,12,16,20,24,28,1,5,9,13,21,17,25,29,2,6,10,14,18,22,26,30,3,7,11,15,19,23,27,31"
MAP_ep64="0,32,16,12,48,4,36,20,44,1,33,8,40,52,17,24,56,9,28,60,5,41,37,13,2,49,21,25,53,3,11,57,35,29,61,45,7,34,39,43,19,51,15,47,31,23,27,55,63,59,30,62,6,38,10,42,18,14,50,46,26,22,58,54"

MAP_ft16="0,4,1,2,12,5,6,13,8,14,10,9,3,7,11,15"
MAP_ft32="0,4,8,12,16,20,24,28,1,5,9,13,17,21,25,29,2,6,10,14,18,22,26,30,3,7,11,15,19,23,27,31"
MAP_ft64="0,32,1,4,2,17,8,3,7,9,13,24,41,5,29,61,23,20,27,30,62,18,49,6,31,38,34,33,37,36,50,14,10,46,42,26,22,58,28,16,60,52,40,48,35,12,44,56,15,19,11,55,51,47,59,45,25,63,21,54,39,43,53,57"

MAP_is16="0,1,2,10,3,7,4,8,12,11,14,9,5,6,13,15"
MAP_is32="0,4,8,12,16,20,24,28,1,5,9,13,17,21,25,29,2,6,10,14,18,22,26,30,3,7,11,15,19,23,27,31"
MAP_is64="0,4,32,36,8,40,12,44,1,16,33,2,14,30,48,20,28,24,52,56,3,60,7,35,39,11,15,5,43,19,29,47,51,6,23,25,27,62,55,59,31,34,61,13,63,57,26,9,46,41,37,45,17,21,49,53,38,10,58,18,42,50,22,54"

MAP_lu16="0,8,1,5,4,12,13,9,2,14,3,11,6,10,7,15"
MAP_lu32="0,4,1,5,2,6,10,3,8,12,9,13,22,14,18,7,16,20,17,21,31,26,30,11,24,28,25,29,27,23,19,15"
MAP_lu64="0,20,24,1,2,18,6,30,3,14,56,46,28,52,25,9,10,15,62,41,16,7,47,33,60,21,32,17,39,13,42,22,57,54,12,5,44,19,11,34,29,23,27,61,35,45,26,53,59,49,51,4,36,55,58,8,40,50,38,31,48,37,63,43"

MAP_mg16="0,4,8,12,1,5,9,13,2,10,6,14,3,11,7,15"
MAP_mg32="0,4,8,12,16,24,20,1,5,9,13,21,17,25,29,2,28,6,10,14,18,22,26,30,3,7,11,15,23,19,27,31"
MAP_mg64="0,4,32,36,1,5,12,9,41,8,40,16,48,2,20,24,56,52,44,28,29,61,60,37,13,33,45,17,49,21,25,53,57,34,6,38,10,22,42,3,14,46,18,50,30,54,31,62,63,27,26,59,23,35,55,58,19,11,43,15,51,47,7,39"

MAP_sp16="0,1,13,2,4,5,9,10,3,15,7,12,6,14,8,11"
MAP_sp25="0,4,24,1,5,8,16,13,9,2,22,3,19,10,6,7,11,23,14,18,15,12,20,21,17"
MAP_sp64="0,1,32,2,17,49,3,11,15,26,10,13,7,27,34,59,30,45,31,9,25,22,35,57,58,6,29,14,16,61,19,41,18,51,12,20,52,8,50,5,4,38,47,24,43,46,21,54,33,39,23,40,63,44,55,36,62,37,48,53,28,60,56,42"

usage() {
	echo "Usage: $0 <version> <#threads> <#runs> <size> <benchmarks> <mapping>"
	echo "Available Mappings: round-robin (RR), random static (RS), operating system (OS)"
	exit $1
}

if [ $# -ne 6 ]; then
	usage 1
fi

VER=${1^^}
THREADS=$2
RUNS=$3
SIZE=${4^^}
BM=${5,,}
MAP_ALGO=${6^^}

PUS=$(cat /proc/cpuinfo | grep processor | tail -1 | awk '{print $3}')
if [ $(($THREADS-1)) -gt $PUS ]; then
	echo "Number of threads larger than number of processors, cannot continue"
	usage 4
fi

do_map() {
	MAP="-binding user:"
	case ${MAP_ALGO} in
		"RR") # round robin
			for j in $(seq 0 $(($THREADS-1))); do
				MAP="$MAP$j,"
			done
			MAP=${MAP:0:${#MAP} - 1}
			;;

		"RS") # random static
			unset mapped
			mapped=()
			RANDOM=$1
			for j in $(seq 0 $(($THREADS-1))); do
				while [ 1 ]; do
					cpu=$(($RANDOM%$(($PUS+1))))
					if [ "${mapped[$cpu]}" != "x" ]; then break; fi
				done
				mapped[$cpu]="x"
				MAP="$MAP$cpu,"
			done
			MAP=${MAP:0:${#MAP} - 1}
			;;

		"OS") # OS mapping, do nothing
			MAP=""
			;;

		"SPCD") # SPCD handles mapping, do nothing
			MAP=""
			;;

		"ORACLE")
			varname=MAP_$bm$THREADS
			MAP+=${!varname}
			;;

		*)
			echo "Illegal Mapping '${MAP_ALGO}'"
			usage 2
			;;
	esac
}

DIR="NPB3.3-$VER/bin"

OUTPATH=results/$VER/$THREADS/$SIZE/$MAP_ALGO

for bm in $BM; do
	mkdir -p $OUTPATH/$bm
	for run in $(seq 1 $RUNS); do
		do_map $run $bm# calculate new mapping for this run
		name=$OUTPATH/$bm/$(date|tr ' ' '-').txt # name of output file
		cmd="mpirun $MAP -np $THREADS $DIR/$bm.$SIZE.$THREADS"
		echo "Run $run - $cmd" | tee $name
		$cmd | tee -a $name
		sleep 1
	done
done
